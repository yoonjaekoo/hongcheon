<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìµëª… ê²Œì‹œíŒ </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .loading-bar { height: 4px; background-color: #3b82f6; width: 0; transition: width 0.3s ease; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">
                    ğŸ« ìš°ë¦¬ í•™êµ
                </h1>
                <div id="auth-info" class="text-sm text-gray-500 rounded-full bg-gray-100 p-2">
                    <!-- ì¸ì¦ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
                </div>
            </div>
        </header>

        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
        <div id="loading-indicator" class="loading-bar"></div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- ìµëª… ê¸€ì“°ê¸° ì„¹ì…˜ (2/3 ì§€ì ) -->
                <div class="lg:col-span-1">
                    <div id="post-form-card" class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100/50 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">ìµëª…ìœ¼ë¡œ ì´ì•¼ê¸°í•˜ê¸°</h2>
                        <form id="post-form" onsubmit="event.preventDefault(); submitPost()">
                            
                            <div class="mb-4">
                                <label for="post-title" class="block text-sm font-medium text-gray-600 mb-1">ì œëª©</label>
                                <input type="text" id="post-title" placeholder="ì†”ì§í•œ ì œëª©ì„ ì ì–´ì£¼ì„¸ìš” (ìµœëŒ€ 50ì)" maxlength="50" required 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div class="mb-6">
                                <label for="post-content" class="block text-sm font-medium text-gray-600 mb-1">ë‚´ìš©</label>
                                <textarea id="post-content" rows="6" placeholder="ììœ ë¡­ê²Œ ì˜ê²¬ì„ ë‚˜ëˆ ì£¼ì„¸ìš”. ê°œì¸ ì •ë³´ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”!" required 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                            </div>

                            <button type="submit" id="submit-button"
                                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50"
                                    disabled>
                                ğŸš€ ìµëª… ê²Œì‹œê¸€ ë“±ë¡
                            </button>
                        </form>
                    </div>
                </div>

                <!-- ê²Œì‹œê¸€ ëª©ë¡ ì„¹ì…˜ (1/3 ì§€ì ) -->
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">ì „ì²´ ê²Œì‹œíŒ</h2>
                    <div id="posts-list" class="space-y-4">
                        <!-- ê²Œì‹œê¸€ë“¤ì´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. -->
                        <p id="empty-state" class="text-center text-gray-500 py-12 bg-white rounded-xl shadow-md border">ì•„ì§ ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    </div>
                </div>
            </div>

            <!-- ë©”ì‹œì§€ ëª¨ë‹¬ -->
            <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">ì•Œë¦¼</h3>
                    <p id="modal-content" class="text-gray-600 mb-4"></p>
                    <button onclick="closeModal()" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition">í™•ì¸</button>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // Firebase ì´ˆê¸°í™” ë° Firestore/Auth ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹…ìš©)
        setLogLevel('debug');
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // =================================================================
        // 1. App ID ì„¤ì • (Firestore ì»¬ë ‰ì…˜ ê²½ë¡œì— ì‚¬ìš©ë¨)
        // ì´ ê°’ì€ Firestore ê·œì¹™ì—ì„œ ì‚¬ìš©í•˜ëŠ” 'appId' ê²½ë¡œì— í•´ë‹¹í•˜ë©°, ê³ ìœ í•˜ê²Œ ìœ ì§€í•´ì•¼ í•´.
        const appId = "school-anonymous-board-v1"; // Firestore ê²½ë¡œ: /artifacts/school-anonymous-board-v1/public/data/posts

        // 2. Firebase í”„ë¡œì íŠ¸ ì„¤ì • ì •ë³´ (ì‚¬ìš©ìê°€ ì œê³µí•œ ì‹¤ì œ í‚¤ ì ìš©)
        const firebaseConfig = {
            apiKey: "AIzaSyANZjd0jAQDj-tRed5tP-FB_08XBRXFrdU",
            authDomain: "hongcheon-ae71e.firebaseapp.com",
            projectId: "hongcheon-ae71e",
            storageBucket: "hongcheon-ae71e.firebasestorage.app",
            messagingSenderId: "638841201305",
            appId: "1:638841201305:web:6503e0cb5cf9ab2011ce08",
            // measurementId: "G-8SSJGFP8WT" // ë¶„ì„ ê¸°ëŠ¥ì€ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ì œì™¸í•¨
        };
        
        // Custom Token ì¸ì¦ì€ GitHub Pagesì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ë¬´ì‹œí•¨.
        const initialAuthToken = null; 

        // ê¸°íƒ€ DOM ìš”ì†Œ ë° ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        const loadingBar = document.getElementById('loading-indicator');
        const submitButton = document.getElementById('submit-button');
        const modal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        window.showModal = (title, content) => {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        function startLoading() {
            loadingBar.style.width = '30%';
            loadingBar.style.transitionDuration = '10s'; 
        }

        function finishLoading() {
            loadingBar.style.width = '100%';
            loadingBar.style.transitionDuration = '0.3s';
            setTimeout(() => {
                loadingBar.style.width = '0%';
                loadingBar.style.transitionDuration = '0s';
            }, 300);
        }

        // 3. Firebase ì´ˆê¸°í™” ë° ì¸ì¦ (ìµëª… ë¡œê·¸ì¸ë§Œ ì‚¬ìš©)
        async function initializeFirebase() {
            startLoading();
            // ì‹¤ì œ í‚¤ë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— í‚¤ ìœ íš¨ì„± ê²€ì‚¬ëŠ” ì œê±°í•¨.
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-info').textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}... (ìµëª… ì¸ì¦ ì™„ë£Œ)`;
                        submitButton.disabled = false;
                        console.log("Firebase Auth State Changed. User ID:", userId);
                    } else {
                        userId = null;
                        document.getElementById('auth-info').textContent = 'ì¸ì¦ ëŒ€ê¸° ì¤‘...';
                        submitButton.disabled = true;
                        console.log("Firebase Auth State Changed. No user.");
                    }
                    isAuthReady = true;
                    finishLoading();
                });

                // ë¬´ì¡°ê±´ ìµëª… ë¡œê·¸ì¸ ì‚¬ìš©
                await signInAnonymously(auth);
                console.log("Signed in Anonymously.");


            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                // Firebase í‚¤ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•ˆë‚´
                showModal("ì¸ì¦ ì˜¤ë¥˜", "Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í‚¤ ì •ë³´ë‚˜ Firestore ê·œì¹™ì„ í™•ì¸í•´ ì£¼ì„¸ìš”. (Error: " + error.message + ")");
                finishLoading();
            }
        }
        
        // 4. ìµëª… ê²Œì‹œê¸€ ì‘ì„± ë¡œì§
        window.submitPost = async () => {
            if (!isAuthReady || !userId) {
                showModal("ì˜¤ë¥˜", "ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                return;
            }

            const titleInput = document.getElementById('post-title');
            const contentInput = document.getElementById('post-content');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title || !content) {
                showModal("ê²½ê³ ", "ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'ë“±ë¡ ì¤‘...';

            try {
                // Firestore ê³µê°œ ì»¬ë ‰ì…˜ ê²½ë¡œ ì‚¬ìš©
                const postsCollection = collection(db, `artifacts/${appId}/public/data/posts`);

                const newPost = {
                    title: title,
                    content: content,
                    author_display: "ìµëª…", 
                    hidden_author_uid: userId, 
                    timestamp: serverTimestamp(), 
                };

                await addDoc(postsCollection, newPost);

                // ì„±ê³µ ë©”ì‹œì§€ ë° í¼ ì´ˆê¸°í™”
                showModal("ì„±ê³µ", "ìµëª… ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                titleInput.value = '';
                contentInput.value = '';
                
            } catch (e) {
                console.error("ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                showModal("ì˜¤ë¥˜", "ê²Œì‹œê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Error: " + e.message + ")");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'ğŸš€ ìµëª… ê²Œì‹œê¸€ ë“±ë¡';
            }
        };

        // 5. ê²Œì‹œê¸€ ëª©ë¡ ì‹¤ì‹œê°„ ê°€ì ¸ì˜¤ê¸° ë° ë Œë”ë§
        function setupPostListener() {
            if (!db) {
                console.warn("Firestore is not initialized. Skipping listener setup.");
                return;
            }

            const postsList = document.getElementById('posts-list');
            const emptyState = document.getElementById('empty-state');
            
            // Firestore ì¿¼ë¦¬: posts ì»¬ë ‰ì…˜ì—ì„œ timestampë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const postsCollection = collection(db, `artifacts/${appId}/public/data/posts`);
            const q = query(postsCollection, orderBy("timestamp", "desc"));

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(q, (snapshot) => {
                postsList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                let postCount = 0;

                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postId = doc.id;
                    postCount++;

                    // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§·íŒ…
                    let timeString = 'ë“±ë¡ ì¤‘...';
                    if (post.timestamp && post.timestamp.toDate) {
                        const date = post.timestamp.toDate();
                        timeString = date.toLocaleDateString("ko-KR", { 
                            year: 'numeric', month: '2-digit', day: '2-digit', 
                            hour: '2-digit', minute: '2-digit' 
                        });
                    }

                    // ê²Œì‹œê¸€ ì¹´ë“œ ìƒì„±
                    const postElement = document.createElement('div');
                    postElement.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-400/80 hover:shadow-xl transition duration-200';
                    postElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${post.title}</h3>
                            <span class="text-sm font-semibold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full">${post.author_display}</span>
                        </div>
                        <p class="text-gray-700 whitespace-pre-wrap mb-4">${post.content}</p>
                        <div class="text-xs text-gray-400 flex justify-between">
                            <span>${timeString}</span>
                            <!-- ê¸€ IDëŠ” ë””ë²„ê¹… ë° íŠ¹ì • ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ìœ ìš© -->
                            <span class="opacity-0 lg:opacity-100">ID: ${postId}</span>
                        </div>
                    `;
                    postsList.appendChild(postElement);
                });

                // ê²Œì‹œê¸€ì´ ì—†ì„ ê²½ìš° ë¹ˆ ìƒíƒœ í‘œì‹œ
                if (postCount === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
                
            }, (error) => {
                console.error("ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                showModal("ë°ì´í„° ì˜¤ë¥˜", "ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // ì•± ì‹œì‘
        window.onload = async () => {
            await initializeFirebase();
            // ì¸ì¦ì´ ì™„ë£Œëœ í›„ì— ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user || !initialAuthToken) { 
                    setupPostListener();
                    unsubscribe(); 
                }
            });
        };
    </script>
</body>
</html>
